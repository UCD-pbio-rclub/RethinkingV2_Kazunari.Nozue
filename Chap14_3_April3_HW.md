---
title: "Chap14_3"
author: "Kazu"
date: "4/1/2020"
output: 
  html_document: 
    keep_md: yes
editor_options: 
  chunk_output_type: console
---



# 14.4. Social relations as correlated varying effects

```r
data(KosterLeckie) # Gift exchange data
?KosterLeckie
kl_dyads
```

```
##     hidA hidB did giftsAB giftsBA offset drel1 drel2 drel3 drel4 dlndist  dass
## 1      1    2   1       0       4  0.000     0     0     1     0  -2.790 0.000
## 2      1    3   2       6      31 -0.003     0     1     0     0  -2.817 0.044
## 3      1    4   3       2       5 -0.019     0     1     0     0  -1.886 0.025
## 4      1    5   4       4       2  0.000     0     1     0     0  -1.892 0.011
## 5      1    6   5       8       2 -0.003     1     0     0     0  -3.499 0.022
## 6      1    7   6       2       1  0.000     0     0     0     0  -1.853 0.071
## 7      1    8   7       1       2  0.000     0     0     0     1  -1.475 0.046
## 8      1    9   8       0       1  0.000     0     0     0     1  -1.644 0.003
## 9      1   10   9      10     110 -0.186     1     0     0     0  -1.897 0.552
## 10     1   11  10       1       0  0.000     0     1     0     0  -2.379 0.018
## 11     1   12  11       0       0 -0.471     0     0     1     0  -2.200 0.004
## 12     1   13  12       0       6 -0.019     0     0     1     0  -2.117 0.004
## 13     1   14  13       1      11 -0.011     0     1     0     0  -2.830 0.036
## 14     1   15  14       6       0 -0.014     0     0     0     0  -2.492 0.006
## 15     1   16  15       0       1 -0.019     0     0     0     0  -1.848 0.014
## 16     1   17  16       0       4 -0.019     0     0     0     1  -2.580 0.000
## 17     1   18  17       0       0 -0.019     0     0     0     0  -2.184 0.025
## 18     1   19  18       0       2  0.000     0     0     0     1  -1.883 0.000
## 19     1   20  19       0       0 -0.028     0     0     1     0  -2.089 0.012
## 20     1   21  20       0       7 -0.031     0     0     0     1  -2.364 0.007
## 21     1   22  21       0       0  0.000     0     0     0     1  -2.538 0.010
## 22     1   23  22       0      13 -0.092     0     1     0     0  -4.068 0.012
## 23     1   24  23       0       0  0.000     0     0     0     0  -1.824 0.000
## 24     1   25  24      16       2 -0.637     0     0     1     0  -1.766 0.080
## 25     2    3  25       1       3 -0.003     0     0     1     0  -2.111 0.007
## 26     2    4  26       2       1 -0.019     0     0     1     0  -1.580 0.013
## 27     2    5  27       0       1  0.000     0     0     1     0  -1.571 0.000
## 28     2    6  28       3       0 -0.003     0     1     0     0  -2.401 0.000
## 29     2    7  29       0       1  0.000     0     0     0     0  -1.609 0.000
## 30     2    8  30      43      10  0.000     1     0     0     0  -1.274 0.252
## 31     2    9  31       5       4  0.000     1     0     0     0  -1.534 0.035
## 32     2   10  32       0       1 -0.186     0     0     0     1  -1.560 0.010
## 33     2   11  33       1       0  0.000     0     0     1     0  -1.877 0.004
## 34     2   12  34       0       0 -0.471     0     0     0     1  -1.779 0.000
## 35     2   13  35       1       2 -0.019     0     0     0     1  -1.711 0.000
## 36     2   14  36       1       0 -0.011     0     0     1     0  -2.277 0.000
## 37     2   15  37       2       0 -0.014     0     0     0     0  -2.074 0.027
## 38     2   16  38       4       2 -0.019     0     0     0     1  -1.567 0.000
## 39     2   17  39      22      16 -0.019     1     0     0     0  -3.434 0.239
## 40     2   18  40       1       1 -0.019     0     0     0     1  -2.198 0.019
## 41     2   19  41       6       9  0.000     1     0     0     0  -1.832 0.093
## 42     2   20  42       0       5 -0.028     0     0     0     1  -1.953 0.000
## 43     2   21  43       1       3 -0.031     0     0     1     0  -2.078 0.011
## 44     2   22  44      14      25  0.000     1     0     0     0  -2.322 0.194
## 45     2   23  45       2       5 -0.092     0     0     1     0  -2.558 0.017
## 46     2   24  46       5       2  0.000     0     0     1     0  -1.692 0.070
## 47     2   25  47       1       0 -0.637     0     0     0     1  -1.464 0.010
## 48     3    4  48      15       0 -0.022     0     1     0     0  -2.252 0.085
## 49     3    5  49      23       2 -0.003     0     1     0     0  -2.307 0.116
## 50     3    6  50      49       4 -0.005     1     0     0     0  -3.442 0.118
## 51     3    7  51       6       0 -0.003     0     0     0     0  -2.056 0.012
## 52     3    8  52       3       0 -0.003     0     0     0     1  -1.678 0.020
## 53     3    9  53       0       0 -0.003     0     0     0     1  -1.675 0.009
## 54     3   10  54       2       8 -0.186     0     0     1     0  -2.384 0.018
## 55     3   11  55      11       1 -0.003     0     1     0     0  -3.321 0.024
## 56     3   12  56       7       0 -0.471     0     0     1     0  -2.814 0.016
## 57     3   13  57       7       2 -0.022     0     0     1     0  -2.763 0.026
## 58     3   14  58      12       2 -0.014     0     1     0     0  -2.798 0.113
## 59     3   15  59      22       4 -0.017     1     0     0     0  -2.635 0.028
## 60     3   16  60       5       1 -0.022     0     0     0     0  -2.150 0.046
## 61     3   17  61      10       5 -0.022     0     0     0     1  -2.024 0.015
## 62     3   18  62       0       0 -0.022     0     0     0     0  -1.958 0.033
## 63     3   19  63       4       0 -0.003     0     0     0     1  -1.797 0.014
## 64     3   20  64       3       1 -0.031     0     0     1     0  -2.023 0.039
## 65     3   21  65       2       1 -0.033     0     0     0     1  -2.348 0.006
## 66     3   22  66       2       1 -0.003     0     0     0     1  -2.304 0.006
## 67     3   23  67      13      26 -0.095     0     1     0     0  -3.107 0.146
## 68     3   24  68       2       0 -0.003     0     0     0     0  -1.840 0.041
## 69     3   25  69       9       0 -0.637     0     0     1     0  -2.178 0.018
## 70     4    5  70       1       8 -0.019     0     1     0     0  -4.035 0.140
## 71     4    6  71      19       4 -0.022     1     0     0     0  -2.099 0.093
## 72     4    7  72       0       1 -0.019     0     0     1     0  -2.926 0.040
## 73     4    8  73       0       0 -0.019     0     0     0     1  -1.473 0.000
## 74     4    9  74       0       1 -0.019     0     0     0     1  -1.999 0.015
## 75     4   10  75       1       8 -0.210     0     0     1     0  -2.968 0.010
## 76     4   11  76       2       0 -0.019     0     1     0     0  -2.637 0.027
## 77     4   12  77       1       3 -0.502     0     0     1     0  -3.089 0.012
## 78     4   13  78       1      11 -0.059     0     0     1     0  -2.896 0.020
## 79     4   14  79       0       6 -0.031     0     1     0     0  -2.252 0.147
## 80     4   15  80       2       2 -0.033     0     0     0     0  -2.453 0.021
## 81     4   16  81       7      17 -0.059     0     0     0     0  -3.942 0.064
## 82     4   17  82       1       3 -0.059     0     0     0     1  -1.594 0.008
## 83     4   18  83       0       1 -0.059     0     0     0     0  -1.813 0.028
## 84     4   19  84       0       2 -0.019     0     0     0     1  -1.866 0.000
## 85     4   20  85       0       2 -0.048     0     0     1     0  -2.070 0.080
## 86     4   21  86       0       5 -0.051     0     0     0     1  -2.273 0.000
## 87     4   22  87       0       2 -0.019     0     0     0     1  -2.033 0.026
## 88     4   23  88       1      13 -0.092     0     1     0     0  -1.947 0.115
## 89     4   24  89       1       0 -0.019     0     0     0     0  -2.108 0.000
## 90     4   25  90       1       1 -0.674     0     1     0     0  -2.857 0.030
## 91     5    6  91      13      17 -0.003     1     0     0     0  -2.113 0.362
## 92     5    7  92       1       3  0.000     0     0     0     0  -2.644 0.000
## 93     5    8  93       0       0  0.000     0     0     0     1  -1.551 0.000
## 94     5    9  94       0       2  0.000     0     0     0     1  -1.879 0.000
## 95     5   10  95       2      17 -0.186     0     0     1     0  -3.386 0.000
## 96     5   11  96       1       3  0.000     0     1     0     0  -2.749 0.044
## 97     5   12  97       1       5 -0.471     0     0     1     0  -3.210 0.058
## 98     5   13  98       2      19 -0.019     0     0     1     0  -3.156 0.068
## 99     5   14  99       1       2 -0.011     0     1     0     0  -2.209 0.000
## 100    5   15 100       4       2 -0.014     0     0     0     0  -2.371 0.036
## 101    5   16 101       3       7 -0.019     0     0     0     0  -3.296 0.000
## 102    5   17 102       1       3 -0.019     0     0     0     1  -1.572 0.016
## 103    5   18 103       0       0 -0.019     0     0     0     0  -1.748 0.000
## 104    5   19 104       1       1  0.000     0     0     0     1  -1.776 0.000
## 105    5   20 105       3       3 -0.028     0     0     1     0  -1.970 0.017
## 106    5   21 106       1       3 -0.031     0     0     0     1  -2.178 0.000
## 107    5   22 107       1       5  0.000     0     0     0     1  -1.970 0.000
## 108    5   23 108       0      11 -0.092     0     1     0     0  -1.965 0.034
## 109    5   24 109       0       1  0.000     0     0     0     0  -1.982 0.000
## 110    5   25 110       3       1 -0.637     0     0     1     0  -3.201 0.098
## 111    6    7 111       0       2 -0.003     0     0     0     0  -2.018 0.009
## 112    6    8 112       0       0 -0.003     0     0     1     0  -1.544 0.031
## 113    6    9 113       0       0 -0.003     0     0     1     0  -1.718 0.000
## 114    6   10 114       0      29 -0.186     0     0     1     0  -2.121 0.027
## 115    6   11 115       3       4 -0.003     1     0     0     0  -2.771 0.033
## 116    6   12 116       0       1 -0.475     0     0     1     0  -2.517 0.028
## 117    6   13 117       0       9 -0.019     0     0     1     0  -2.404 0.000
## 118    6   14 118       5      25 -0.011     1     0     0     0  -3.139 0.092
## 119    6   15 119       0       2 -0.017     0     0     0     0  -2.763 0.000
## 120    6   16 120       0       2 -0.019     0     0     0     1  -2.041 0.007
## 121    6   17 121       0       6 -0.019     0     0     1     0  -2.301 0.000
## 122    6   18 122       0       0 -0.019     0     0     0     1  -2.153 0.012
## 123    6   19 123       0       2 -0.003     0     0     1     0  -1.913 0.010
## 124    6   20 124       0       1 -0.031     0     0     1     0  -2.156 0.000
## 125    6   21 125       0       6 -0.031     0     0     1     0  -2.510 0.002
## 126    6   22 126       1       0 -0.003     0     0     1     0  -2.569 0.005
## 127    6   23 127       4      50 -0.092     1     0     0     0  -3.882 0.099
## 128    6   24 128       0       0 -0.003     0     0     0     1  -1.906 0.016
## 129    6   25 129       2       1 -0.637     0     0     1     0  -1.959 0.033
## 130    7    8 130       0       1  0.000     0     0     0     0  -1.276 0.037
## 131    7    9 131       0       5  0.000     0     0     0     0  -2.503 0.024
## 132    7   10 132       0       4 -0.186     0     0     0     0  -2.264 0.000
## 133    7   11 133       3       2  0.000     0     0     0     0  -2.265 0.022
## 134    7   12 134       0       2 -0.471     0     0     0     0  -2.525 0.123
## 135    7   13 135       3       6 -0.019     0     0     0     0  -2.309 0.000
## 136    7   14 136       2       1 -0.011     0     0     0     0  -2.310 0.015
## 137    7   15 137       3       4 -0.014     0     0     0     0  -2.588 0.065
## 138    7   16 138       8       4 -0.019     0     0     0     0  -3.330 0.101
## 139    7   17 139       2       4 -0.019     0     0     0     0  -1.667 0.000
## 140    7   18 140       0       1 -0.019     0     0     0     1  -2.041 0.149
## 141    7   19 141       0       0  0.000     0     0     0     0  -2.216 0.000
## 142    7   20 142       0       8 -0.028     0     0     0     0  -2.445 0.070
## 143    7   21 143       0      18 -0.031     0     0     0     0  -2.552 0.074
## 144    7   22 144       0       1  0.000     0     0     0     0  -2.221 0.035
## 145    7   23 145       0       7 -0.092     0     0     0     0  -1.875 0.028
## 146    7   24 146       4       4  0.000     0     0     0     0  -2.651 0.094
## 147    7   25 147       2       2 -0.637     0     0     0     0  -2.199 0.032
## 148    8    9 148       2       5  0.000     0     1     0     0  -1.031 0.070
## 149    8   10 149       0       4 -0.186     0     0     0     0  -1.723 0.000
## 150    8   11 150       2       0  0.000     0     0     1     0  -1.686 0.000
## 151    8   12 151       2       0 -0.471     0     0     0     0  -1.600 0.000
## 152    8   13 152       1       3 -0.019     0     0     0     0  -1.714 0.000
## 153    8   14 153       2       8 -0.011     0     0     0     1  -1.397 0.051
## 154    8   15 154       1       0 -0.014     0     0     0     0  -1.374 0.013
## 155    8   16 155       2       2 -0.019     0     0     0     0  -1.392 0.000
## 156    8   17 156       2      16 -0.019     0     1     0     0  -1.194 0.139
## 157    8   18 157       0       2 -0.019     0     0     0     0  -1.115 0.000
## 158    8   19 158       1      10  0.000     0     1     0     0  -1.051 0.130
## 159    8   20 159       0      11 -0.028     0     0     0     0  -1.154 0.000
## 160    8   21 160       0       4 -0.031     0     0     0     1  -1.277 0.039
## 161    8   22 161       4       6  0.000     0     1     0     0  -1.250 0.060
## 162    8   23 162       0       7 -0.092     0     0     0     1  -1.550 0.000
## 163    8   24 163       1       2  0.000     0     0     1     0  -1.098 0.000
## 164    8   25 164       0       2 -0.637     0     0     0     1  -1.708 0.111
## 165    9   10 165       0       0 -0.186     0     0     0     0  -1.687 0.000
## 166    9   11 166       0       0  0.000     0     0     0     1  -1.750 0.003
## 167    9   12 167       1       0 -0.471     0     0     0     0  -1.867 0.000
## 168    9   13 168       0       3 -0.019     0     0     0     0  -1.734 0.000
## 169    9   14 169       1       1 -0.011     0     0     0     1  -1.991 0.006
## 170    9   15 170       9       0 -0.014     0     0     0     0  -2.144 0.011
## 171    9   16 171      10       3 -0.019     0     0     0     0  -2.143 0.006
## 172    9   17 172      11       8 -0.019     0     1     0     0  -1.644 0.091
## 173    9   18 173       4       2 -0.019     0     0     0     0  -2.191 0.023
## 174    9   19 174       9       3  0.000     0     1     0     0  -2.729 0.066
## 175    9   20 175       3      23 -0.028     0     0     1     0  -2.607 0.112
## 176    9   21 176       3      15 -0.031     0     0     0     1  -2.309 0.013
## 177    9   22 177       1       3  0.000     0     1     0     0  -2.129 0.009
## 178    9   23 178       1       2 -0.092     0     0     0     1  -1.625 0.021
## 179    9   24 179      75      26  0.000     1     0     0     0  -3.440 0.477
## 180    9   25 180       0       0 -0.637     0     0     0     1  -1.646 0.006
## 181   10   11 181      16       1 -0.186     0     0     1     0  -2.859 0.028
## 182   10   12 182      15       0 -0.627     0     0     0     1  -3.078 0.000
## 183   10   13 183      11      10 -0.210     0     0     1     0  -3.522 0.021
## 184   10   14 184      13       3 -0.210     0     0     1     0  -2.113 0.023
## 185   10   15 185      16       1 -0.186     0     0     0     0  -2.205 0.000
## 186   10   16 186      16       2 -0.186     0     0     0     0  -2.648 0.000
## 187   10   17 187       9       3 -0.210     0     0     0     0  -1.537 0.000
## 188   10   18 188       2       0 -0.210     0     0     0     0  -1.639 0.000
## 189   10   19 189       4       0 -0.186     0     0     0     0  -1.630 0.000
## 190   10   20 190       3       0 -0.186     0     0     0     1  -1.807 0.011
## 191   10   21 191       6       5 -0.223     0     0     0     0  -2.012 0.000
## 192   10   22 192       6       1 -0.186     0     0     0     0  -1.858 0.000
## 193   10   23 193       4       3 -0.254     0     0     1     0  -1.992 0.000
## 194   10   24 194       2       0 -0.186     0     0     0     0  -1.784 0.029
## 195   10   25 195      48       7 -0.863     0     0     0     1  -3.859 0.271
## 196   11   12 196      22      36 -0.471     1     0     0     0  -3.638 0.454
## 197   11   13 197       6      92 -0.019     1     0     0     0  -3.583 0.180
## 198   11   14 198       2      10 -0.011     0     1     0     0  -2.642 0.020
## 199   11   15 199       1       1 -0.014     0     0     0     0  -2.667 0.015
## 200   11   16 200       1       3 -0.019     0     0     0     0  -2.461 0.000
## 201   11   17 201       0       2 -0.019     0     0     0     1  -1.835 0.000
## 202   11   18 202       0       0 -0.019     0     0     0     0  -1.889 0.000
## 203   11   19 203       0       1  0.000     0     0     0     1  -1.801 0.000
## 204   11   20 204       0       2 -0.028     0     0     1     0  -2.031 0.052
## 205   11   21 205       0       6 -0.031     0     0     0     1  -2.348 0.008
## 206   11   22 206       0       0  0.000     0     0     0     1  -2.206 0.027
## 207   11   23 207       0      13 -0.092     0     1     0     0  -2.533 0.028
## 208   11   24 208       0       4  0.000     0     0     0     0  -1.906 0.000
## 209   11   25 209       1       0 -0.637     0     0     1     0  -2.546 0.016
## 210   12   13 210       6      48 -0.502     0     0     1     0  -3.758 0.209
## 211   12   14 211       3       0 -0.488     0     0     1     0  -2.588 0.039
## 212   12   15 212       1       0 -0.471     0     0     0     0  -2.739 0.006
## 213   12   16 213       0       2 -0.502     0     0     0     0  -2.828 0.007
## 214   12   17 214       0       0 -0.471     0     0     0     0  -1.767 0.000
## 215   12   18 215       0       0 -0.502     0     0     0     0  -1.905 0.000
## 216   12   19 216       0       1 -0.471     0     0     0     0  -1.866 0.000
## 217   12   20 217       0       1 -0.471     0     0     0     1  -2.106 0.019
## 218   12   21 218       1       6 -0.520     0     0     0     0  -2.419 0.005
## 219   12   22 219       0       0 -0.471     0     0     0     0  -2.207 0.015
## 220   12   23 220       0       5 -0.553     0     0     1     0  -2.305 0.006
## 221   12   24 221       0       1 -0.471     0     0     0     0  -2.023 0.000
## 222   12   25 222       1       0 -1.236     0     0     0     1  -2.729 0.000
## 223   13   14 223      51      27 -0.019     0     1     0     0  -2.364 0.228
## 224   13   15 224       5       1 -0.033     0     0     0     0  -2.447 0.000
## 225   13   16 225       8       1 -0.039     0     0     0     0  -2.620 0.000
## 226   13   17 226       0       0 -0.039     0     0     0     0  -1.680 0.000
## 227   13   18 227       0       0 -0.039     0     0     0     0  -1.768 0.000
## 228   13   19 228       2       0 -0.019     0     0     0     0  -1.726 0.173
## 229   13   20 229      10      10 -0.048     0     0     0     1  -1.931 0.036
## 230   13   21 230       2       0 -0.051     0     0     0     0  -2.193 0.034
## 231   13   22 231       0       0 -0.019     0     0     0     0  -2.033 0.000
## 232   13   23 232       2       2 -0.113     0     0     1     0  -2.234 0.000
## 233   13   24 233       1       2 -0.019     0     0     0     0  -1.863 0.000
## 234   13   25 234      11       0 -0.637     0     0     0     1  -2.984 0.000
## 235   14   15 235       6       2 -0.025     0     0     0     0  -3.723 0.015
## 236   14   16 236       0       2 -0.031     0     0     0     0  -2.243 0.012
## 237   14   17 237       5       7 -0.031     0     0     0     1  -2.323 0.036
## 238   14   18 238       0       2 -0.031     0     0     0     0  -2.508 0.000
## 239   14   19 239       2       3 -0.011     0     0     0     1  -2.246 0.000
## 240   14   20 240       2      12 -0.039     0     0     1     0  -2.616 0.058
## 241   14   21 241       2      13 -0.042     0     0     0     1  -3.272 0.004
## 242   14   22 242       0       1 -0.011     0     0     0     1  -3.224 0.008
## 243   14   23 243       1      10 -0.104     0     1     0     0  -2.808 0.067
## 244   14   24 244       1       1 -0.011     0     0     0     0  -2.249 0.000
## 245   14   25 245       0       0 -0.637     0     0     1     0  -1.963 0.033
## 246   15   16 246      11      35 -0.033     1     0     0     0  -2.472 0.464
## 247   15   17 247       0       7 -0.033     0     0     0     0  -2.135 0.059
## 248   15   18 248       0       2 -0.033     0     0     0     1  -2.475 0.010
## 249   15   19 249       1       1 -0.014     0     0     0     1  -2.339 0.000
## 250   15   20 250       1      13 -0.031     0     1     0     0  -2.775 0.048
## 251   15   21 251       2      39 -0.045     0     0     0     1  -3.647 0.052
## 252   15   22 252       2       8 -0.014     0     0     0     0  -3.073 0.059
## 253   15   23 253       0       3 -0.107     0     0     0     0  -2.500 0.010
## 254   15   24 254       0       3 -0.014     0     0     0     0  -2.437 0.013
## 255   15   25 255       0       2 -0.637     0     0     0     0  -2.055 0.044
## 256   16   17 256       2       3 -0.039     0     0     0     0  -1.596 0.074
## 257   16   18 257       1       3 -0.039     0     0     1     0  -1.863 0.000
## 258   16   19 258       3       7 -0.019     0     0     1     0  -1.955 0.000
## 259   16   20 259       2       8 -0.048     0     0     1     0  -2.160 0.055
## 260   16   21 260       2      39 -0.051     0     0     1     0  -2.334 0.049
## 261   16   22 261       0       7 -0.019     0     0     0     0  -2.067 0.055
## 262   16   23 262       1       9 -0.113     0     0     0     0  -1.895 0.044
## 263   16   24 263       0       2 -0.019     0     0     0     0  -2.248 0.000
## 264   16   25 264       2       1 -0.637     0     0     0     1  -2.582 0.000
## 265   17   18 265       4       2 -0.039     0     0     0     0  -2.477 0.056
## 266   17   19 266       8      10 -0.019     0     1     0     0  -2.010 0.016
## 267   17   20 267       4      16 -0.048     0     0     0     0  -2.117 0.018
## 268   17   21 268       3       9 -0.051     0     0     0     1  -2.196 0.007
## 269   17   22 269       8      19 -0.019     0     1     0     0  -2.511 0.145
## 270   17   23 270       1       3 -0.113     0     0     0     1  -2.376 0.000
## 271   17   24 271       5       5 -0.019     0     0     1     0  -1.816 0.082
## 272   17   25 272       3       0 -0.674     0     0     0     1  -1.446 0.000
## 273   18   19 273       3       1 -0.019     0     0     0     1  -2.996 0.035
## 274   18   20 274       2       1 -0.048     0     0     0     0  -3.101 0.000
## 275   18   21 275      15      62 -0.042     1     0     0     0  -2.797 0.447
## 276   18   22 276       1       1 -0.019     0     0     1     0  -3.180 0.065
## 277   18   23 277       0       1 -0.113     0     0     0     0  -2.085 0.000
## 278   18   24 278       4       3 -0.019     0     0     0     0  -2.482 0.053
## 279   18   25 279       1       0 -0.674     0     0     0     1  -1.555 0.045
## 280   19   20 280       1      15 -0.028     0     0     0     0  -3.380 0.082
## 281   19   21 281       5      17 -0.031     0     0     0     1  -2.649 0.140
## 282   19   22 282      10      15  0.000     0     1     0     0  -2.615 0.109
## 283   19   23 283       0       3 -0.092     0     0     0     1  -1.829 0.131
## 284   19   24 284       2       1  0.000     0     0     1     0  -3.127 0.000
## 285   19   25 285       3       2 -0.637     0     0     0     1  -1.563 0.000
## 286   20   21 286       9      12 -0.059     0     0     0     0  -3.302 0.015
## 287   20   22 287       3       2 -0.028     0     0     0     0  -3.079 0.053
## 288   20   23 288       3       8 -0.122     0     1     0     0  -2.038 0.119
## 289   20   24 289      13       3 -0.028     0     0     0     1  -3.161 0.074
## 290   20   25 290       0       0 -0.637     0     0     0     1  -1.721 0.032
## 291   21   22 291      18       5 -0.031     0     0     0     1  -3.486 0.019
## 292   21   23 292       9       1 -0.125     0     0     0     1  -2.326 0.015
## 293   21   24 293       0       0 -0.031     0     0     0     0  -2.690 0.010
## 294   21   25 294       9       1 -0.696     0     0     1     0  -1.895 0.043
## 295   22   23 295       1       1 -0.092     0     0     0     1  -2.434 0.076
## 296   22   24 296       0       1  0.000     0     0     1     0  -2.442 0.000
## 297   22   25 297       2       0 -0.637     0     0     0     1  -1.747 0.026
## 298   23   24 298       2       0 -0.092     0     0     0     0  -1.798 0.000
## 299   23   25 299       4       0 -0.818     0     0     1     0  -1.848 0.031
## 300   24   25 300       2       0 -0.637     0     0     0     0  -1.723 0.042
##     d0125
## 1       0
## 2       0
## 3       0
## 4       0
## 5       0
## 6       0
## 7       0
## 8       0
## 9       0
## 10      0
## 11      0
## 12      0
## 13      0
## 14      0
## 15      0
## 16      0
## 17      0
## 18      0
## 19      0
## 20      0
## 21      0
## 22      0
## 23      0
## 24      1
## 25      0
## 26      0
## 27      0
## 28      0
## 29      0
## 30      0
## 31      0
## 32      0
## 33      0
## 34      0
## 35      0
## 36      0
## 37      0
## 38      0
## 39      0
## 40      0
## 41      0
## 42      0
## 43      0
## 44      0
## 45      0
## 46      0
## 47      0
## 48      0
## 49      0
## 50      0
## 51      0
## 52      0
## 53      0
## 54      0
## 55      0
## 56      0
## 57      0
## 58      0
## 59      0
## 60      0
## 61      0
## 62      0
## 63      0
## 64      0
## 65      0
## 66      0
## 67      0
## 68      0
## 69      0
## 70      0
## 71      0
## 72      0
## 73      0
## 74      0
## 75      0
## 76      0
## 77      0
## 78      0
## 79      0
## 80      0
## 81      0
## 82      0
## 83      0
## 84      0
## 85      0
## 86      0
## 87      0
## 88      0
## 89      0
## 90      0
## 91      0
## 92      0
## 93      0
## 94      0
## 95      0
## 96      0
## 97      0
## 98      0
## 99      0
## 100     0
## 101     0
## 102     0
## 103     0
## 104     0
## 105     0
## 106     0
## 107     0
## 108     0
## 109     0
## 110     0
## 111     0
## 112     0
## 113     0
## 114     0
## 115     0
## 116     0
## 117     0
## 118     0
## 119     0
## 120     0
## 121     0
## 122     0
## 123     0
## 124     0
## 125     0
## 126     0
## 127     0
## 128     0
## 129     0
## 130     0
## 131     0
## 132     0
## 133     0
## 134     0
## 135     0
## 136     0
## 137     0
## 138     0
## 139     0
## 140     0
## 141     0
## 142     0
## 143     0
## 144     0
## 145     0
## 146     0
## 147     0
## 148     0
## 149     0
## 150     0
## 151     0
## 152     0
## 153     0
## 154     0
## 155     0
## 156     0
## 157     0
## 158     0
## 159     0
## 160     0
## 161     0
## 162     0
## 163     0
## 164     0
## 165     0
## 166     0
## 167     0
## 168     0
## 169     0
## 170     0
## 171     0
## 172     0
## 173     0
## 174     0
## 175     0
## 176     0
## 177     0
## 178     0
## 179     0
## 180     0
## 181     0
## 182     0
## 183     0
## 184     0
## 185     0
## 186     0
## 187     0
## 188     0
## 189     0
## 190     0
## 191     0
## 192     0
## 193     0
## 194     0
## 195     0
## 196     0
## 197     0
## 198     0
## 199     0
## 200     0
## 201     0
## 202     0
## 203     0
## 204     0
## 205     0
## 206     0
## 207     0
## 208     0
## 209     0
## 210     0
## 211     0
## 212     0
## 213     0
## 214     0
## 215     0
## 216     0
## 217     0
## 218     0
## 219     0
## 220     0
## 221     0
## 222     0
## 223     0
## 224     0
## 225     0
## 226     0
## 227     0
## 228     0
## 229     0
## 230     0
## 231     0
## 232     0
## 233     0
## 234     0
## 235     0
## 236     0
## 237     0
## 238     0
## 239     0
## 240     0
## 241     0
## 242     0
## 243     0
## 244     0
## 245     0
## 246     0
## 247     0
## 248     0
## 249     0
## 250     0
## 251     0
## 252     0
## 253     0
## 254     0
## 255     0
## 256     0
## 257     0
## 258     0
## 259     0
## 260     0
## 261     0
## 262     0
## 263     0
## 264     0
## 265     0
## 266     0
## 267     0
## 268     0
## 269     0
## 270     0
## 271     0
## 272     0
## 273     0
## 274     0
## 275     0
## 276     0
## 277     0
## 278     0
## 279     0
## 280     0
## 281     0
## 282     0
## 283     0
## 284     0
## 285     0
## 286     0
## 287     0
## 288     0
## 289     0
## 290     0
## 291     0
## 292     0
## 293     0
## 294     0
## 295     0
## 296     0
## 297     0
## 298     0
## 299     0
## 300     0
```

```r
kl_households
```

```
##    hid hgame hfish hpigs hwealth hpastor
## 1    1  0.05  0.06  0.00  14.162       0
## 2    2  0.25  0.17  1.75  27.405       0
## 3    3  2.29  0.66  5.75   9.900       0
## 4    4  0.04  0.43  1.50   7.267       0
## 5    5  0.07  0.12  1.25   9.982       0
## 6    6  0.03  0.20  2.50  16.186       0
## 7    7  0.27  0.74  3.00   8.068       0
## 8    8  0.04  0.16  2.00  17.437       0
## 9    9  0.39  0.30  5.75  16.931       0
## 10  10  6.09  0.04  0.00  17.421       0
## 11  11  0.05  0.27  3.00  12.353       0
## 12  12  0.11  0.52  1.00   8.000       0
## 13  13  2.21  0.34  3.50   9.272       0
## 14  14  0.27  0.36  5.75  20.627       1
## 15  15  0.07  0.04  2.25  14.173       0
## 16  16  0.03  0.19  5.25   7.596       0
## 17  17  0.28  0.31  7.75  19.222       1
## 18  18  0.10  0.10  9.50  23.677       0
## 19  19  0.01  0.03  3.75  15.907       0
## 20  20  0.87  0.45  5.75   8.707       0
## 21  21  3.52  0.17  4.75  16.088       0
## 22  22  0.76  0.06  0.50  24.104       0
## 23  23  1.88  0.32  7.67  26.974       0
## 24  24  0.02  0.03  5.00  20.494       0
## 25  25  0.01  0.21  0.50   9.897       0
```


```r
kl_data <- list(
    N = nrow(kl_dyads),
    N_households = max(kl_dyads$hidB),
    did = kl_dyads$did,
    hidA = kl_dyads$hidA,
    hidB = kl_dyads$hidB,
    giftsAB = kl_dyads$giftsAB,
    giftsBA = kl_dyads$giftsBA
)
m14.4 <- ulam(
    alist(
        giftsAB ~ poisson( lambdaAB ),
        giftsBA ~ poisson( lambdaBA ),
        log(lambdaAB) <- a + gr[hidA,1] + gr[hidB,2] + d[did,1] ,
        log(lambdaBA) <- a + gr[hidB,1] + gr[hidA,2] + d[did,2] ,
        a ~ normal(0,1),
       ## gr matrix of varying effects
       vector[2]:gr[N_households] ~ multi_normal(0,Rho_gr,sigma_gr),
    Rho_gr ~ lkj_corr(4),
    sigma_gr ~ exponential(1),
   ## dyad effects
    transpars> matrix[N,2]:d <-
            compose_noncentered( rep_vector(sigma_d,2) , L_Rho_d , z ),
    matrix[2,N]:z ~ normal( 0 , 1 ),
    cholesky_factor_corr[2]:L_Rho_d ~ lkj_corr_cholesky( 8 ),
    sigma_d ~ exponential(1),
   ## compute correlation matrix for dyads
    gq> matrix[2,2]:Rho_d <<- Chol_to_Corr( L_Rho_d )
), data=kl_data , chains=4 , cores=4 , iter=2000 )
```

```
## Warning: The largest R-hat is NA, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess
```

# HW (April 3, 2020). PDF3


```r
data(bangladesh) # Contraceptive use data from 1934 Bangladeshi women.
```


```r
d <- bangladesh # right?
 sort(unique(d$district))
```

```
##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
## [26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
## [51] 51 52 53 55 56 57 58 59 60 61
```
* District 54 is absent. So district isn’t yet a good index variable, because it’s not contiguous. 

* indexing district

```r
 d$district_id <- as.integer(as.factor(d$district))
sort(unique(d$district_id))
```

```
##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
## [26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
## [51] 51 52 53 54 55 56 57 58 59 60
```
* Now there are 60 values, contiguous integers 1 to 60. (from book)

Revisit 13H1 using the data.
* predicting use.contraception
* raw data analysis

```r
# check raw data
d <- d %>% mutate(use.contraception =as.character(use.contraception))
d  %>% ggplot(aes(x=district_id,fill=use.contraception)) + geom_bar(position="fill") + scale_y_continuous(labels = scales::percent)
```

![](Chap14_3_April3_HW_files/figure-html/unnamed-chunk-3-1.png)<!-- -->

```r
# 
d.summary1 <- d %>% group_by(district_id) %>% summarise(num.all=n())

d.summary2 <- d %>% group_by(district_id) %>% count(use.contraception) %>% filter(use.contraception==1) %>% rename(num.use=n)
d.summary <- d.summary1 %>% left_join(d.summary2,by="district_id") 
d.summary %>% View
d %>% filter(district_id %in% c(11,49)) # zero
```

```
##    woman district use.contraception living.children age.centered urban
## 1    365       11                 0               1      -9.5599     0
## 2    366       11                 0               1      -8.5599     0
## 3    367       11                 0               2      -5.5599     0
## 4    368       11                 0               2      18.4400     0
## 5    369       11                 0               1      -8.5599     0
## 6    370       11                 0               1      -9.5599     0
## 7    371       11                 0               1     -12.5590     0
## 8    372       11                 0               1       3.4400     0
## 9    373       11                 0               1      -8.5599     0
## 10   374       11                 0               4      19.4400     0
## 11   375       11                 0               1      -3.5599     0
## 12   376       11                 0               2      -5.5599     0
## 13   377       11                 0               2       2.4400     0
## 14   378       11                 0               2       0.4400     0
## 15   379       11                 0               1     -11.5590     0
## 16   380       11                 0               3      -2.5599     0
## 17   381       11                 0               4       2.4400     0
## 18   382       11                 0               2      -8.5599     0
## 19   383       11                 0               1      -8.5599     0
## 20   384       11                 0               1      -6.5600     0
## 21   385       11                 0               4      18.4400     0
## 22  1600       49                 0               1     -12.5590     0
## 23  1601       49                 0               1      -9.5599     0
## 24  1602       49                 0               1     -10.5590     0
## 25  1603       49                 0               4       2.4400     0
##    district_id
## 1           11
## 2           11
## 3           11
## 4           11
## 5           11
## 6           11
## 7           11
## 8           11
## 9           11
## 10          11
## 11          11
## 12          11
## 13          11
## 14          11
## 15          11
## 16          11
## 17          11
## 18          11
## 19          11
## 20          11
## 21          11
## 22          49
## 23          49
## 24          49
## 25          49
```

```r
d.summary$use.contraception[is.na(d.summary$use.contraception)] <- 0
d.summary$use.contraception[is.na(d.summary$num.use)] <- 0
# calculate rate use
d.summary <- d.summary %>% mutate(rate.use = num.use/num.all)
# add living children
d.summary3 <- d %>% group_by(district_id) %>% summarize(living.children.mean=mean(living.children))
# urban rate
d.summary4 <- d %>% group_by(district_id) %>% count(urban) %>% spread(key="urban",value="n") %>% mutate(urban=replace_na(`1`,0))
# combine all
d.summary <- d.summary %>% left_join(d.summary3, by="district_id") %>% left_join(d.summary4 %>% dplyr::select(district_id,urban), by="district_id") %>% dplyr::select(district_id, num.all,num.use,rate.use,living.children.mean,urban) %>% mutate(urban.rate=urban/num.all)
# plot
d.summary %>% ggplot(aes(x=urban.rate,y=rate.use)) +geom_point(aes(size=living.children.mean))
```

```
## Warning: Removed 2 rows containing missing values (geom_point).
```

![](Chap14_3_April3_HW_files/figure-html/unnamed-chunk-3-2.png)<!-- -->

```r
d.summary %>% ggplot(aes(x=living.children.mean,y=rate.use)) +geom_point(aes(size=urban.rate))
```

```
## Warning: Removed 2 rows containing missing values (geom_point).
```

![](Chap14_3_April3_HW_files/figure-html/unnamed-chunk-3-3.png)<!-- -->

# model1

```r
d1 <- with(d, 
          list(use=as.integer(use.contraception), d_id=district_id, urban=urban))
str(d1)
```

```
## List of 3
##  $ use  : int [1:1934] 0 0 0 0 0 0 0 0 0 0 ...
##  $ d_id : int [1:1934] 1 1 1 1 1 1 1 1 1 1 ...
##  $ urban: int [1:1934] 1 1 1 1 1 1 1 1 1 1 ...
```

```r
m.Bangladish1 <- ulam(
    alist(
        use ~ dbinom(1, p),
  logit(p) <- a[d_id] + b[d_id]*urban,
  a[d_id] ~ dnorm(a_bar,sigma_a),
  b[d_id] ~ dnorm(b_bar,sigma_b),
  a_bar ~ dnorm(0,1),
  b_bar ~ dnorm(0,1),
  c(sigma_a, sigma_b) ~ dexp(1)), data=d1 , chains=4 , cores=2 , iter=1000 )
```

```
## Warning: There were 1 chains where the estimated Bayesian Fraction of Missing Information was low. See
## http://mc-stan.org/misc/warnings.html#bfmi-low
```

```
## Warning: Examine the pairs() plot to diagnose sampling problems
```

```
## Warning: The largest R-hat is 1.1, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess
```

```r
precis(m.Bangladish1,depth=2)
```

```
##                mean         sd         5.5%        94.5%      n_eff     Rhat4
## a[1]    -1.38506309 0.24956419 -1.813585927 -1.015357084 1278.48288 1.0003118
## a[2]    -0.66266740 0.34212176 -1.225909146 -0.134097565 2942.05173 0.9997115
## a[3]    -0.48478240 0.50252237 -1.257258424  0.345589863 2992.33116 0.9984302
## a[4]    -0.56147142 0.32247992 -1.071517724 -0.043275613 1387.67312 1.0024184
## a[5]    -0.65395645 0.28077633 -1.106339164 -0.223827544 3317.37568 0.9990179
## a[6]    -0.93906139 0.24869126 -1.336804887 -0.555452807 2749.39254 0.9991334
## a[7]    -0.83746888 0.36198493 -1.411341337 -0.270082380 2864.06598 1.0003564
## a[8]    -0.60710908 0.28793855 -1.068173012 -0.151126560 2588.79454 0.9996553
## a[9]    -0.82560733 0.33050437 -1.355048685 -0.305833552 2690.04802 0.9989120
## a[10]   -1.19015159 0.41396417 -1.893944785 -0.556505914 2331.14943 1.0001918
## a[11]   -1.56085315 0.43029000 -2.291645980 -0.932803763 1327.94579 1.0006576
## a[12]   -0.72985700 0.33292454 -1.276197206 -0.206896062 3276.84354 0.9986862
## a[13]   -0.59331399 0.33295661 -1.112947175 -0.081588978 2957.31589 0.9985553
## a[14]   -0.43485397 0.31263999 -0.927645818  0.058569900  699.93431 1.0069263
## a[15]   -0.72941082 0.35255786 -1.294851646 -0.145911804 3438.80861 0.9995895
## a[16]   -0.26820980 0.34475619 -0.820009651  0.280048683 3299.50484 0.9985946
## a[17]   -0.80487255 0.32196614 -1.334185504 -0.296500657 3833.23284 0.9991560
## a[18]   -0.84232961 0.27741033 -1.287812734 -0.408857203 3712.24413 0.9989977
## a[19]   -0.65298441 0.31826302 -1.173191057 -0.158575393 3167.14186 1.0004285
## a[20]   -0.57458815 0.35687330 -1.148279607 -0.032769151 4738.53949 0.9984390
## a[21]   -0.61355721 0.37036332 -1.206036200 -0.030410714 1573.89362 0.9998528
## a[22]   -1.01973641 0.35651708 -1.633326204 -0.480682757 2670.96095 0.9992567
## a[23]   -0.83830626 0.38497346 -1.465114709 -0.253545453 2896.58726 0.9994411
## a[24]   -1.21266089 0.41599688 -1.910249732 -0.595385649 1922.69772 0.9994286
## a[25]   -0.39648392 0.23106413 -0.759068632 -0.020721812 2273.02320 1.0011272
## a[26]   -0.60938348 0.35833379 -1.175348720 -0.033396368 3078.83630 0.9988754
## a[27]   -1.25668411 0.29311357 -1.730106858 -0.799409495 2337.90366 1.0009816
## a[28]   -1.01563591 0.27029039 -1.444990544 -0.594531340 3225.64464 0.9988010
## a[29]   -0.97990650 0.31880230 -1.500589120 -0.492687754 2586.06194 1.0007922
## a[30]   -0.39271475 0.25340427 -0.798723768  0.001765761 3030.98159 0.9998988
## a[31]   -0.44224669 0.28524017 -0.901929407  0.015025618 3158.67622 0.9986003
## a[32]   -1.01954576 0.34190492 -1.586303205 -0.469547614 2618.47320 0.9995628
## a[33]   -0.72806352 0.38336333 -1.331572145 -0.136379656 2716.33589 0.9989636
## a[34]    0.17136703 0.31650101 -0.320593214  0.681442778 1045.40718 1.0031095
## a[35]   -0.37852700 0.27328354 -0.805003473  0.060601854 3110.08945 1.0003568
## a[36]   -0.71045418 0.34761019 -1.291360870 -0.179298532 2899.66985 0.9995339
## a[37]   -0.33859691 0.39643438 -0.952877442  0.305797394 3420.40228 0.9992423
## a[38]   -0.97082937 0.37441490 -1.577655864 -0.383394990 2480.64531 0.9989101
## a[39]   -0.31758073 0.31211243 -0.816549360  0.176840231 3578.05921 0.9992130
## a[40]   -0.59411787 0.33808945 -1.134689499 -0.046479330 2135.88835 1.0002891
## a[41]   -0.29759137 0.30347698 -0.777148946  0.170772665 2920.97141 0.9989961
## a[42]   -0.40288967 0.41002625 -1.044325822  0.250595624 1969.65064 1.0009229
## a[43]   -0.27121449 0.26906328 -0.694307384  0.177491069 3109.40398 0.9987279
## a[44]   -0.99885491 0.32622064 -1.537543827 -0.494248731 2575.29130 0.9985243
## a[45]   -0.78853204 0.28051200 -1.237106750 -0.353301114 3076.15365 0.9984697
## a[46]   -0.12945313 0.21682177 -0.468196094  0.217403922 2937.71600 0.9999108
## a[47]   -0.56490723 0.38164990 -1.168045972  0.044312157 2631.93525 0.9989072
## a[48]   -0.30827442 0.28193353 -0.767942097  0.140148392 2867.81423 0.9994749
## a[49]   -0.96598327 0.46957098 -1.750986229 -0.223605928 2853.75972 0.9997618
## a[50]   -0.50548631 0.35463070 -1.077695441  0.060425389 3012.90747 1.0012709
## a[51]   -0.59822951 0.31632983 -1.090659418 -0.087100135 2518.33307 1.0000243
## a[52]   -0.32793866 0.26250255 -0.729758681  0.093922518 1135.95582 1.0042476
## a[53]   -0.79503627 0.40844108 -1.451451305 -0.158494610 1908.64736 0.9997939
## a[54]   -0.95566153 0.45093719 -1.669633108 -0.256463356 2695.01438 0.9999013
## a[55]   -0.19985061 0.28744121 -0.631200446  0.266624864 2223.75908 0.9990216
## a[56]   -1.15027880 0.33081823 -1.679924242 -0.639952726 2290.74961 0.9993533
## a[57]   -0.41512325 0.31650823 -0.921978337  0.109997351 1759.38171 1.0027682
## a[58]   -1.07441614 0.42328437 -1.775562025 -0.427772527 1549.02745 1.0003870
## a[59]   -1.13071273 0.32576563 -1.665928579 -0.607723172 2536.39280 0.9991847
## a[60]   -1.18001557 0.31030300 -1.683401731 -0.704269676 2403.11810 0.9998198
## b[1]     0.77549261 0.30557332  0.298998516  1.294733228 1135.40042 1.0007184
## b[2]     0.61605320 0.58310113 -0.309705273  1.549083058 2034.73679 1.0026931
## b[3]     0.86357671 0.56657701  0.053592528  1.823685815 1021.42527 1.0049526
## b[4]     1.32721855 0.56332799  0.549775529  2.271822613  249.95147 1.0294191
## b[5]     0.62390340 0.52609227 -0.213884303  1.471040507 2368.26068 0.9989671
## b[6]     1.01946798 0.50166962  0.288335124  1.875200227  639.16122 1.0083692
## b[7]     0.60870593 0.56637498 -0.313785223  1.489068168 2433.01423 0.9997640
## b[8]     0.88202531 0.54923482  0.118777475  1.805378745 1091.73795 1.0067001
## b[9]     0.75217995 0.53179504 -0.042287177  1.654723933 2362.95519 1.0007230
## b[10]    0.60618753 0.57761326 -0.294501371  1.509095034 2267.03263 0.9993101
## b[11]    0.61811610 0.59718672 -0.301941377  1.567034393 1942.23944 1.0012897
## b[12]    0.44374557 0.48272760 -0.353141891  1.168004592 1639.38992 1.0046193
## b[13]    0.43724222 0.44951012 -0.300653524  1.112809120 2187.20314 1.0023097
## b[14]    1.07564150 0.34970956  0.540186334  1.654163232  423.86782 1.0144917
## b[15]    0.47412025 0.44610014 -0.253677561  1.160802943 1899.33093 0.9995960
## b[16]    0.85233909 0.58131750 -0.025659038  1.890969373 1595.84806 1.0026029
## b[17]    0.60462814 0.61863410 -0.425574799  1.587791285 1849.44295 0.9998942
## b[18]    0.71565826 0.40357168  0.105633452  1.389834406 2545.17032 1.0011950
## b[19]    0.87096568 0.55685604  0.047992565  1.820262808 1068.91367 1.0063868
## b[20]    0.61957579 0.61676932 -0.340033034  1.628420677 2105.93415 0.9996152
## b[21]    0.06124391 0.53308646 -0.864279992  0.796028445  308.24346 1.0219985
## b[22]    0.62588921 0.59252356 -0.314704214  1.583762472 2324.31342 1.0011490
## b[23]    0.60329646 0.60111047 -0.385948838  1.538102592 2227.52653 0.9995130
## b[24]    0.62210893 0.59883054 -0.355766535  1.572127801 2300.01685 0.9990461
## b[25]    0.37492144 0.39142031 -0.253582974  0.942383186 1196.65632 1.0068034
## b[26]    0.62349399 0.60842876 -0.333239364  1.596693373 2002.78913 1.0001766
## b[27]    0.67185453 0.47388111 -0.088241763  1.433565687 2170.41541 1.0006625
## b[28]    0.45200862 0.48830121 -0.356364755  1.174728349 1372.79396 1.0028595
## b[29]    0.82827156 0.47639625  0.122405752  1.621476396 1503.51943 1.0037700
## b[30]    1.03221203 0.42271889  0.402237810  1.718432005  493.32021 1.0110202
## b[31]    0.55896636 0.47335321 -0.199268430  1.315955989 2290.54061 1.0017310
## b[32]    0.60504852 0.61099434 -0.382915228  1.544899668 1490.88848 1.0002659
## b[33]    0.92837951 0.49402065  0.181316111  1.745116411  794.58391 1.0103962
## b[34]    0.06451956 0.53742309 -0.845200949  0.842418234  337.85153 1.0216892
## b[35]    0.60003792 0.37610683  0.001093852  1.198879502 2252.21126 1.0012616
## b[36]    0.50319817 0.50788622 -0.351987827  1.280712720 2211.99965 0.9992888
## b[37]    0.61068854 0.58947567 -0.334936453  1.546208804 1848.87235 0.9988837
## b[38]    0.81209444 0.48720637  0.049392677  1.620266432 2016.91322 1.0002014
## b[39]    0.58264470 0.52126913 -0.264615394  1.371676120 2817.80282 0.9988627
## b[40]    0.55322859 0.37029833 -0.040948109  1.139243281 1898.87753 1.0006001
## b[41]    0.17673878 0.57307198 -0.841441632  0.945019289  410.10691 1.0148811
## b[42]    0.24265084 0.53734223 -0.677667887  0.959756943  455.72373 1.0101509
## b[43]    0.63253744 0.39542230  0.029419455  1.264144451 2761.88543 0.9990014
## b[44]    0.63725774 0.56971543 -0.284664214  1.556759741 2496.50666 1.0000789
## b[45]    0.98124696 0.51736640  0.253958862  1.891219007  507.90909 1.0107988
## b[46]    0.71002776 0.43317760  0.033671344  1.411105351 2920.94674 1.0039586
## b[47]    0.59604776 0.46793239 -0.136561655  1.354843038 2837.95756 0.9995956
## b[48]    0.59373507 0.38912904 -0.032230305  1.217108155 2118.06084 1.0022935
## b[49]    0.63398398 0.59114439 -0.261114616  1.537666000 1371.52333 0.9999015
## b[50]    1.04137862 0.55715010  0.259445808  1.994843736  460.54862 1.0175081
## b[51]    0.80623515 0.41083413  0.175054987  1.483136275 1226.89522 1.0034775
## b[52]   -0.07618789 0.47014881 -0.897524743  0.607842541  252.05881 1.0288963
## b[53]    0.52786529 0.42639053 -0.142778596  1.182176388 2254.70697 0.9983609
## b[54]    0.28773260 0.53568113 -0.660338835  1.012975786  725.26403 1.0087208
## b[55]    0.66674297 0.37816759  0.086863491  1.269454303 2367.45013 0.9995317
## b[56]    0.49538954 0.48721711 -0.290824470  1.230720882 1932.33652 1.0010963
## b[57]    0.15104232 0.46151211 -0.645517733  0.793075892  415.49774 1.0180074
## b[58]    0.62807893 0.58818943 -0.290063024  1.513568703 1730.12720 0.9998513
## b[59]    0.47874828 0.44227702 -0.247063070  1.141339654 1794.06678 1.0035344
## b[60]    0.43456768 0.43962797 -0.295391689  1.079078012 1649.00190 1.0006973
## a_bar   -0.69746587 0.09090555 -0.840815772 -0.550757370 1316.51411 0.9999795
## b_bar    0.61599539 0.14737084  0.381979295  0.847055961  791.84088 1.0044093
## sigma_b  0.53397314 0.20741050  0.229721966  0.884425261   84.64946 1.0824060
## sigma_a  0.47943578 0.08932882  0.341269596  0.634321351  453.22680 1.0055775
```

* correlation of intercept and slope. plot the varying effect estimates for both the intercepts and slopes, by district.

```r
# extract posterior means of partially pooled estimates
post <- extract.samples(m.Bangladish1) 
post$a %>% head()
```

```
##           [,1]       [,2]       [,3]       [,4]        [,5]       [,6]
## [1,] -1.275010 -0.6227425 -0.7118178 -0.4020450 -0.20189935 -0.9453974
## [2,] -1.287642 -1.2798494 -1.2185721 -0.7948808 -0.60628150 -0.9560645
## [3,] -1.368833 -1.0474313  0.2290726 -0.3654137 -0.39954663 -1.2753238
## [4,] -1.410778 -0.3144151 -1.5095263 -0.5280232 -0.79424196 -0.6814371
## [5,] -1.103367 -0.5919667  0.3353734 -0.4352274 -0.09294645 -1.1331005
## [6,] -2.017981 -0.4844511 -0.3886738 -0.9872349 -0.78908670 -1.5335264
##            [,7]       [,8]       [,9]      [,10]     [,11]      [,12]
## [1,] -1.0933969 -0.8699336 -0.6270997 -1.0677667 -1.480282 -0.6204634
## [2,] -0.2755789 -0.2903528 -0.7771388 -1.2198996 -1.608948 -0.7918311
## [3,] -0.7504625 -0.3239348 -0.8753658 -1.2748068 -1.654639 -0.6911842
## [4,] -0.5839150 -0.4569316 -1.2532775 -1.4041313 -1.354583 -1.0308015
## [5,] -0.4942814 -0.5235247 -0.9444319 -0.7307499 -1.221625 -0.3048958
## [6,] -1.3320498 -0.5861737 -1.1578434 -2.0438487 -2.306162 -0.9028330
##           [,13]       [,14]       [,15]       [,16]      [,17]      [,18]
## [1,] -0.1883537 -0.02841320 -0.78045540  0.13728074 -0.9977800 -0.7296310
## [2,] -1.0117196 -0.20277391 -0.85389313 -0.13290606 -0.1954765 -0.8787606
## [3,] -0.9075626 -0.29678892 -0.47934774 -0.73708168 -1.1903438 -0.8247645
## [4,] -0.9555454 -0.39427324 -0.64336014 -0.30632301 -0.9664350 -1.1318146
## [5,] -0.8534500 -0.08531922 -0.79925119 -0.69131875 -0.2915333 -1.0728559
## [6,] -0.5627988 -0.90020151  0.07813852  0.02157696 -1.0972337 -0.2659891
##           [,19]      [,20]      [,21]      [,22]      [,23]      [,24]
## [1,] -0.6037062 -0.1819475 -1.1012722 -1.3734624 -0.9195907 -0.7681943
## [2,]  0.3662904 -0.9068134 -0.4099871 -1.2954308 -0.4827281 -2.0183441
## [3,] -0.5860323 -0.9344436 -0.9887451 -0.8341812 -0.1392968 -0.7425253
## [4,] -0.5581314 -0.5557029 -0.9694368 -1.0352817 -0.8280121 -1.6716683
## [5,] -0.6386833 -0.6291697 -0.7073676 -0.7497658 -0.6603987  0.1436111
## [6,] -1.2767186 -0.0823408 -0.5904460 -1.1716615 -0.3011711 -1.4849427
##           [,25]      [,26]      [,27]      [,28]      [,29]      [,30]
## [1,] -0.4765935 -0.7565540 -1.0172275 -1.0681219 -1.2852493 -0.4626715
## [2,] -0.4749864 -0.8530798 -1.4118946 -0.8939212 -1.2544310 -0.1715350
## [3,] -0.2026811 -0.2548382 -0.8107484 -1.2363536 -0.6482816 -0.3325811
## [4,] -0.5727595 -1.2061744 -1.8991591 -1.0286401 -1.3164674 -0.3877897
## [5,]  0.1317296 -0.7049107 -1.1931740 -1.0600573 -0.6546053 -0.5150766
## [6,]  0.1402823 -0.7255844 -1.4276591 -0.7404489 -1.2178725 -0.1880059
##           [,31]      [,32]      [,33]     [,34]        [,35]      [,36]
## [1,] -0.5266458 -0.5135216 -0.9372488 0.1176390 -0.543508833 -0.8676063
## [2,] -1.1000650 -1.0551362 -0.7349908 0.8158890 -0.227982734 -1.3705944
## [3,] -0.5613055 -1.2321555 -1.0196762 0.3780295  0.003614691 -0.8108486
## [4,] -0.5673359 -1.0785742 -0.5879444 0.2038269 -0.286141065 -0.7041405
## [5,] -0.2365836 -0.9971189 -1.1155337 0.3975064 -0.056729056 -0.4131680
## [6,] -0.2927424 -1.3228005 -0.5485435 0.5588166 -0.208649944 -0.6788394
##            [,37]      [,38]      [,39]      [,40]        [,41]        [,42]
## [1,] -0.87919992 -1.4800884 -0.3506800 -0.2516218 -0.000185029 -0.307399517
## [2,]  0.33619423 -0.4253027 -0.3841959 -0.5893334  0.079398005  0.111805213
## [3,]  0.11038846 -0.8593922 -0.2299672 -0.3809507 -0.432805810 -0.288651890
## [4,] -0.17481760 -1.2228667 -0.9056486 -1.1692138  0.040858795  0.519212075
## [5,]  0.04535166 -0.7099064 -0.1400330 -0.4608143 -0.035931344  0.007051799
## [6,] -0.75848589 -0.9114942  0.3605006 -0.2096676 -0.247393989  0.348601408
##            [,43]      [,44]      [,45]       [,46]       [,47]      [,48]
## [1,] -0.23400537 -1.5213693 -0.5837915 -0.16233369  0.09279565  0.1347280
## [2,] -0.11790897 -0.7416677 -1.1231727 -0.03996512 -0.30180320 -0.8180943
## [3,] -0.25699690 -1.1402310 -0.9770613 -0.20261050 -0.27430901 -0.4991450
## [4,] -0.24285447 -1.2793289 -0.9157018  0.15458158  0.04523693 -0.3501870
## [5,] -0.23009734 -0.7333219 -0.7480672 -0.41594884 -0.07652344 -0.5940720
## [6,] -0.05730334 -0.6833139 -0.9626698  0.19703693 -0.96242414 -0.5832592
##           [,49]      [,50]      [,51]       [,52]       [,53]      [,54]
## [1,] -1.2709547 -0.0309856 -0.5209826 -0.50978983 -0.21394571 -0.6951444
## [2,] -0.7569276 -0.4670733 -0.3996613  0.14495523 -1.13249393 -1.4488249
## [3,] -0.1169701 -0.8500531 -0.4574657  0.06955459 -0.97724964 -1.4614162
## [4,] -0.7631612 -0.6006586 -0.4806093 -0.32705530 -1.14478868 -0.7727954
## [5,] -0.8207535 -1.0416795 -0.3234044  0.12094705 -0.89217877 -0.5597396
## [6,] -0.3537987 -0.6095566 -0.9897470 -0.20929028 -0.04457871 -1.0279297
##            [,55]      [,56]      [,57]     [,58]      [,59]      [,60]
## [1,]  0.09356629 -1.2205733 -0.5042881 -1.280263 -1.3189858 -0.6383991
## [2,] -0.38738852 -1.2616686 -0.7714514 -1.308442 -1.6969026 -1.6818802
## [3,] -0.27185704 -1.7029989 -0.5291965 -1.203757 -0.4950192 -1.3310701
## [4,] -0.31895249 -1.6788568 -0.3069608 -1.377438 -1.1024394 -0.8468178
## [5,] -0.02702836 -0.8881822 -0.2876271 -1.183942 -0.8678330 -0.6724261
## [6,] -0.48563676 -1.4543301 -0.3332817 -1.311383 -0.9629721 -0.8576726
```

```r
a <- apply( post$a , 2 , mean )
b <- apply( post$b , 2 , mean )
# plot
tibble(a=a,b=b) %>% ggplot() + geom_point(aes(x=a,y=b))  
```

![](Chap14_3_April3_HW_files/figure-html/unnamed-chunk-5-1.png)<!-- -->
*KN: There are correlation

* Plotting predicted proportion of women using contraception, in each district, with urban women on one axis and rural on the other, might also help.



# pdf2.
* Now consider the predictor variables age.centered and living.children, also contained in data(bangladesh). Suppose that age influences contraceptive use (changing attitudes) and number of children (older people have had more time to have kids). Number of children may also directly influence contraceptive use. 
* Draw a DAG that reflects these hypothetical relationships. 

```r
library(dagitty)
dagpdf2 <- dagitty(" dag {
  age -> use
  age -> n_child
  n_child -> use
}")
coordinates(dagpdf2) <- list(
  x=c(use=3, age=2, n_child=2),
  y=c(use=2, age=1, n_child=3))
drawdag(dagpdf2) 
```

![](Chap14_3_April3_HW_files/figure-html/unnamed-chunk-7-1.png)<!-- -->
*Then build models needed to evaluate the DAG. You will need at least two models. Retain district and urban, as in Problem 1. What do you conclude about the causal influence of age and children?

```r
d2 <- with(d, 
          list(use=as.integer(use.contraception), d_id=district_id, urban=urban,age=living.children,children=living.children))
str(d2)
```

```
## List of 5
##  $ use     : int [1:1934] 0 0 0 0 0 0 0 0 0 0 ...
##  $ d_id    : int [1:1934] 1 1 1 1 1 1 1 1 1 1 ...
##  $ urban   : int [1:1934] 1 1 1 1 1 1 1 1 1 1 ...
##  $ age     : int [1:1934] 4 1 3 4 1 1 4 4 2 4 ...
##  $ children: int [1:1934] 4 1 3 4 1 1 4 4 2 4 ...
```
* MO: Needs to be standardized?
** MO: What is the differences between scale and standardize? Look standardize() 

# model m.Bangladish2.1 with urban and children



# model m.Bangladish2.2 wit hurban, children, and age


# compare two models




# pdf3. Modify any models from Problem 2 that contained that children variable and model the variable now as a monotonic ordered category, like education from the week we did ordered categories. Education in that example had 8 categories. Children here will have fewer (no one in the sample had 8 children). So modify the code appropriately. What do you conclude about the causal influence of each additional child on use of contraception?



```r
sessionInfo()
```

```
## R version 3.6.2 (2019-12-12)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Mojave 10.14.6
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
##  [1] forcats_0.5.0        stringr_1.4.0        dplyr_0.8.4         
##  [4] purrr_0.3.3          readr_1.3.1          tidyr_1.0.2         
##  [7] tibble_2.1.3         tidyverse_1.3.0      reshape2_1.4.3      
## [10] lmerTest_3.1-1       lme4_1.1-21          Matrix_1.2-18       
## [13] rethinking_1.95      dagitty_0.2-2        rstan_2.21.1        
## [16] ggplot2_3.3.0        StanHeaders_2.21.0-1
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-145        matrixStats_0.55.0  fs_1.3.1           
##  [4] lubridate_1.7.4     httr_1.4.1          numDeriv_2016.8-1.1
##  [7] tools_3.6.2         backports_1.1.5     R6_2.4.1           
## [10] DBI_1.1.0           colorspace_1.4-1    withr_2.1.2        
## [13] tidyselect_1.0.0    gridExtra_2.3       prettyunits_1.1.1  
## [16] processx_3.4.2      curl_4.3            compiler_3.6.2     
## [19] cli_2.0.2           rvest_0.3.5         xml2_1.2.2         
## [22] labeling_0.3        scales_1.1.0        mvtnorm_1.1-0      
## [25] callr_3.4.2         digest_0.6.25       minqa_1.2.4        
## [28] rmarkdown_2.1       pkgconfig_2.0.3     htmltools_0.4.0    
## [31] dbplyr_1.4.2        rlang_0.4.5         readxl_1.3.1       
## [34] rstudioapi_0.11     shape_1.4.4         generics_0.0.2     
## [37] farver_2.0.3        jsonlite_1.6.1      inline_0.3.15      
## [40] magrittr_1.5        loo_2.2.0           Rcpp_1.0.3         
## [43] munsell_0.5.0       fansi_0.4.1         lifecycle_0.2.0    
## [46] stringi_1.4.6       yaml_2.2.1          MASS_7.3-51.5      
## [49] pkgbuild_1.0.6      plyr_1.8.6          grid_3.6.2         
## [52] crayon_1.3.4        lattice_0.20-40     haven_2.2.0        
## [55] splines_3.6.2       hms_0.5.3           knitr_1.28         
## [58] ps_1.3.2            pillar_1.4.3        boot_1.3-24        
## [61] codetools_0.2-16    stats4_3.6.2        reprex_0.3.0       
## [64] glue_1.3.1          evaluate_0.14       V8_3.0.1           
## [67] RcppParallel_4.4.4  modelr_0.1.6        vctrs_0.2.3        
## [70] nloptr_1.2.1        cellranger_1.1.0    gtable_0.3.0       
## [73] assertthat_0.2.1    xfun_0.12           broom_0.5.5        
## [76] coda_0.19-3         ellipsis_0.3.0
```

